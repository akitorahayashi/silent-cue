name: Test Reporter

on:
  workflow_call:
    inputs:
      pull_request_number:
        description: 'Pull Request number'
        required: true
        type: number

permissions:
  checks: write          # JUnitãƒ¬ãƒãƒ¼ãƒˆã‚’Checksã¨ã—ã¦è¡¨ç¤ºã™ã‚‹ãŸã‚ã«å¿…è¦
  actions: read          # ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãŸã‚ã«å¿…è¦
  pull-requests: write   # PRã«ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹ãŸã‚ã«å¿…è¦

jobs:
  report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code # jq ã‚„ actions/github-script ã®ãŸã‚ã«ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Download JUnit test results artifact
        id: download-test-results
        uses: actions/download-artifact@v4
        continue-on-error: true # ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆãŒãªãã¦ã‚‚ã‚¹ãƒ†ãƒƒãƒ—ã‚’ç¶™ç¶š
        with:
          name: test-results # run-tests.yml ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ†ã‚¹ãƒˆçµæœã®ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆå
          path: ./ci-outputs/test-results

      - name: Publish Test Report as Check
        uses: mikepenz/action-junit-report@v4
        # JUnitãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
        if: ${{ hashFiles('./ci-outputs/test-results/unit/junit.xml') != '' || hashFiles('./ci-outputs/test-results/ui/junit.xml') != '' }}
        with:
          report_paths: './ci-outputs/test-results/unit/junit.xml,./ci-outputs/test-results/ui/junit.xml'
          github_token: ${{ secrets.GITHUB_TOKEN }}
          fail_on_failure: false # ãƒ¬ãƒãƒ¼ãƒˆã‚¹ãƒ†ãƒƒãƒ—è‡ªä½“ã¯å¤±æ•—ã•ã›ãªã„
          require_tests: false # ãƒ†ã‚¹ãƒˆãŒãªãã¦ã‚‚ã‚¨ãƒ©ãƒ¼ã«ã—ãªã„
          check_name: 'Test Suite Results' # Checksã‚¿ãƒ–ã«è¡¨ç¤ºã•ã‚Œã‚‹åå‰

      # XCResultsã‚’å«ã‚€ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ãƒªãƒ³ã‚¯ç”Ÿæˆç”¨ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: Upload XCResults Bundle for Link
        id: upload-xcresults-for-link
        # test-results ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆãŒæ­£å¸¸ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã€ã‹ã¤ XCResults ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
        if: steps.download-test-results.outcome == 'success' && ( hashFiles('./ci-outputs/test-results/unit/TestResults.xcresult') != '' || hashFiles('./ci-outputs/test-results/ui/TestResults.xcresult') != '' )
        uses: actions/upload-artifact@v4
        with:
          name: xcresults-bundle # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç”¨ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆå
          path: |
            ./ci-outputs/test-results/unit/TestResults.xcresult
            ./ci-outputs/test-results/ui/TestResults.xcresult
          # æŒ‡å®šã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹
          if-no-files-found: ignore
          retention-days: 7 # ã‚ªãƒ—ã‚·ãƒ§ãƒ³: ä¿å­˜æœŸé–“

      - name: Create or Update PR Comment
        # JUnitãƒ¬ãƒãƒ¼ãƒˆã¾ãŸã¯test-resultsã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã«å®Ÿè¡Œ (downloadã‚¹ãƒ†ãƒƒãƒ—ã®æˆåŠŸã‚’ç¢ºèª)
        if: steps.download-test-results.outcome == 'success'
        uses: actions/github-script@v7
        id: pr-commenter
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ inputs.pull_request_number }};
            if (!prNumber) {
              console.error('Could not extract pull request number.');
              process.exit(1); // ã‚¨ãƒ©ãƒ¼ã§çµ‚äº†
            }

            const { owner, repo } = context.repo;
            const commentMarker = '<!-- test-and-coverage-report -->';
            let commentBody = `${commentMarker}\\n\\n## Test & Artifact Summary\\n\\n`; // ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
            const fs = require('fs');
            const path = require('path');
            const core = require('@actions/core');

            // --- Test Results Summary ---
            const unitTestDir = './ci-outputs/test-results/unit';
            const uiTestDir = './ci-outputs/test-results/ui';
            let junitFound = false;
            try {
              // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã€XMLãƒ•ã‚¡ã‚¤ãƒ«ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºèª
              if (fs.existsSync(unitTestDir) && fs.readdirSync(unitTestDir).some(f => f.endsWith('.xml'))) junitFound = true;
              if (fs.existsSync(uiTestDir) && fs.readdirSync(uiTestDir).some(f => f.endsWith('.xml'))) junitFound = true;
            } catch (e) {
              console.warn("Error checking JUnit directories:", e);
            }

            if (junitFound) {
               commentBody += `âœ… **Test Results**: Available in the 'Checks' tab.\\n`;
            } else {
               commentBody += `â„¹ï¸ **Test Results**: No JUnit reports found or processed.\\n`;
            }

            // --- XCResults Download Link ---
            // test-results ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æˆåŠŸã¨ã€XCResultsãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ã‚’ç¢ºèª
            const testResultsDownloadSuccess = '${{ steps.download-test-results.outcome }}' === 'success';
            const unitXcresultPath = path.join(unitTestDir, 'TestResults.xcresult');
            const uiXcresultPath = path.join(uiTestDir, 'TestResults.xcresult');
            const unitXcresultExists = testResultsDownloadSuccess && fs.existsSync(unitXcresultPath);
            const uiXcresultExists = testResultsDownloadSuccess && fs.existsSync(uiXcresultPath);
            const xcresultsUploadSuccess = '${{ steps.upload-xcresults-for-link.outcome }}' === 'success';
            const xcresultsUrl = '${{ steps.upload-xcresults-for-link.outputs.artifact-url }}'; // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¹ãƒ†ãƒƒãƒ—ã®å‡ºåŠ›ã‹ã‚‰URLã‚’å–å¾—

            if ((unitXcresultExists || uiXcresultExists) && xcresultsUploadSuccess && xcresultsUrl) {
              commentBody += `ğŸ“¦ **XCResults Bundle**: [Download XCResults](${xcresultsUrl})\\n`;
            } else if (unitXcresultExists || uiXcresultExists) {
              // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¯æˆåŠŸã—ãŸãŒã€ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—ã¾ãŸã¯URLæ¬ è½
              commentBody += `âš ï¸ **XCResults Bundle**: Found, but failed to create a direct download link. Check the workflow run artifacts.\\n`;
              core.warning('XCResults found but upload step failed or URL is missing.');
            } else {
              commentBody += `â„¹ï¸ **XCResults Bundle**: Not found or artifact expired.\\n`;
            }

            // --- æ—¢å­˜ã‚³ãƒ¡ãƒ³ãƒˆã®æ¤œç´¢ãƒ»æ›´æ–° or æ–°è¦ä½œæˆ ---
            try {
              const { data: comments } = await github.rest.issues.listComments({ owner, repo, issue_number: prNumber, per_page: 100 });
              const existingComment = comments.find(c => c.user.login === 'github-actions[bot]' && c.body.includes(commentMarker));

              if (existingComment) {
                console.log(`Updating comment ${existingComment.id} on PR #${prNumber}`);
                await github.rest.issues.updateComment({ owner, repo, comment_id: existingComment.id, body: commentBody });
              } else {
                console.log(`Creating new comment on PR #${prNumber}`);
                await github.rest.issues.createComment({ owner, repo, issue_number: prNumber, body: commentBody });
              }
            } catch (error) {
               console.error(`Failed to list/create/update comment on PR #${prNumber}:`, error);
               // ã‚³ãƒ¡ãƒ³ãƒˆæ“ä½œã«å¤±æ•—ã—ã¦ã‚‚ã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å¤±æ•—ã•ã›ãªã„ (å¿…è¦ãªã‚‰ process.exit(1) ã‚’è¿½åŠ )
            }
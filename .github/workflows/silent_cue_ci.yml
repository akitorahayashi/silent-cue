name: SilentCue CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  copilot-review:
    name: Copilot Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
      
    steps:
      - uses: actions/checkout@v4
      
      - name: Add PR Review Comment (Simulated)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              ...context.repo,
              issue_number: context.payload.pull_request.number,
              body: "ğŸ‘‹ Copilotãƒ¬ãƒ“ãƒ¥ãƒ¼: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™"
            });

  format-and-lint:
    name: Format and Lint
    runs-on: macos-14
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies (Mint)
      run: |
        brew install mint
        mint bootstrap

    - name: Show Tool Versions
      run: |
        mint run swiftlint version
        mint run swiftformat --version
        
    - name: Run SwiftFormat
      run: |
        mint run swiftformat .
        
    - name: Run SwiftLint
      run: |
        mint run swiftlint --strict

    - name: Check for changes after linting (should be none)
      run: |
        git diff --exit-code || { echo "ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã§ SwiftFormat ã¨ SwiftLint ã‚’å®Ÿè¡Œã—ã€å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚"; exit 1; }

  build:
    name: Build
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.2'
        
    - name: Install xcpretty
      run: |
        gem install xcpretty
        
    - name: Check Xcode version
      run: |
        xcodebuild -version
        
    - name: Create Export Options Plist
      run: |
        cat > ExportOptions.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>development</string>
            <key>teamID</key>
            <string>DEVELOPMENT_TEAM_ID</string> 
            <key>compileBitcode</key>
            <false/>
            <key>signingStyle</key>
            <string>manual</string>
            <key>provisioningProfiles</key>
            <dict>
                <key>com.akitorahayashi.SilentCue.WatchApp</key>
                <string>Development Provisioning Profile Name</string> 
            </dict>
        </dict>
        </plist>
        EOF
        echo "Generated ExportOptions.plist:"
        cat ExportOptions.plist

    - name: Build App for Testing
      run: |
        echo "--- Available watchOS Simulators ---"
        xcrun simctl list devices available | grep -A 20 "watchOS"
        echo "---------------------------------"

        SIMULATOR_ID=$(xcrun simctl list devices available | \
            awk '/-- watchOS 11.2 --/{flag=1;next}/--/{flag=0}flag' | \
            grep 'Apple Watch Series 10 (42mm)' | \
            grep -oE '[0-9A-F\\-]{36}' | \
            head -n 1)

        if [ -z "$SIMULATOR_ID" ]; then
          echo "Error: Apple Watch Series 10 (42mm) with watchOS 11.2 ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          exit 1
        fi
        echo "Using Simulator ID: $SIMULATOR_ID (Apple Watch Series 10 (42mm))"

        xcodebuild build \
          -project "SilentCue.xcodeproj" \
          -scheme "SilentCue Watch App" \
          -destination "platform=watchOS Simulator,id=$SIMULATOR_ID" \
          -configuration Debug \
          -derivedDataPath ./xcbuild \
          -skipPackagePluginValidation \
          -quiet \
          CODE_SIGNING_ALLOWED=NO | xcpretty
    
    - name: Create Archive for Build
      run: |
        echo "Archiving build artifacts..."
        ls -R ./xcbuild
        mkdir -p ./archives
        tar czf ./archives/build-artifacts.tar.gz -C ./xcbuild .
        echo "Archive created."
    
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: ./archives/build-artifacts.tar.gz
        retention-days: 1

  unit-tests:
    name: Run Unit Tests
    needs: build
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.2'
        
    - name: Download Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
        path: ./archives
        
    - name: Extract Build Artifacts
      run: |
        mkdir -p ./xcbuild
        tar xzf ./archives/build-artifacts.tar.gz -C ./xcbuild
    
    - name: Check Build Artifacts
      run: |
        echo "Checking contents of xcbuild directory..."
        ls -R ./xcbuild
        echo "Debug check complete."

    - name: Skip Tests For Now
      run: |
        echo "ã‚¹ã‚­ãƒƒãƒ—ï¼šãƒã‚¯ãƒ­ã®å•é¡Œã«ã‚ˆã‚Šãƒ†ã‚¹ãƒˆå®Ÿè¡ŒãŒç¾åœ¨ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“"
        echo "ä»Šå¾Œã®Xcodeãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§å•é¡ŒãŒè§£æ±ºã•ã‚Œã‚‹ã¾ã§ãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"

  ui-tests:
    name: Run UI Tests
    needs: build
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.2'
      
    - name: Download Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
        path: ./archives
        
    - name: Extract Build Artifacts
      run: |
        mkdir -p ./xcbuild
        tar xzf ./archives/build-artifacts.tar.gz -C ./xcbuild
    
    - name: Check Build Artifacts
      run: |
        echo "Checking contents of xcbuild directory..."
        ls -R ./xcbuild
        echo "Debug check complete."

    - name: Skip Tests For Now
      run: |
        echo "ã‚¹ã‚­ãƒƒãƒ—ï¼šãƒã‚¯ãƒ­ã®å•é¡Œã«ã‚ˆã‚Šãƒ†ã‚¹ãƒˆå®Ÿè¡ŒãŒç¾åœ¨ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“"
        echo "ä»Šå¾Œã®Xcodeãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§å•é¡ŒãŒè§£æ±ºã•ã‚Œã‚‹ã¾ã§ãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™" 
name: SilentCue CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  copilot-review:
    name: Copilot Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
      
    steps:
      - uses: actions/checkout@v3
      
      - name: Add PR Review Comment (Simulated)
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              ...context.repo,
              issue_number: context.payload.pull_request.number,
              body: "ğŸ‘‹ Copilotãƒ¬ãƒ“ãƒ¥ãƒ¼: ã‚³ãƒ¼ãƒ‰å…¨ä½“ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™"
            });

  format-and-lint:
    name: Format and Lint
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Install Mint
      run: |
        brew install mint
        
    - name: Install dependencies
      run: |
        mint bootstrap

    - name: Show Tool Versions
      run: |
        mint run swiftlint version
        mint run swiftformat --version
        
    - name: Run SwiftFormat
      run: |
        mint run swiftformat .
        
    - name: Run SwiftLint
      run: |
        mint run swiftlint --strict

    - name: Check for changes after linting (should be none)
      run: |
        git diff --exit-code || { echo "ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã§ SwiftFormat ã¨ SwiftLint ã‚’å®Ÿè¡Œã—ã€å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚"; exit 1; }

  test:
    name: Run Tests
    runs-on: macos-latest
    needs: format-and-lint
    steps:
    - uses: actions/checkout@v3
    
    - name: Select Xcode
      run: sudo xcode-select -s /Applications/Xcode.app
      
    - name: Run Unit Tests
      run: |
        xcodebuild test \
          -project SilentCue.xcodeproj \
          -scheme "SilentCue Watch AppTests" \
          -destination "platform=watchOS Simulator,name=Apple Watch Series 10 (42mm)" \
          -configuration Debug \
          -derivedDataPath ./build \
          -testPlan "SilentCue Watch AppTests" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO

    - name: Run UI Tests
      run: |
        xcodebuild test \
          -project SilentCue.xcodeproj \
          -scheme "SilentCue Watch AppUITests" \
          -destination "platform=watchOS Simulator,name=Apple Watch Series 10 (42mm)" \
          -configuration Debug \
          -derivedDataPath ./build \
          -testPlan "SilentCue Watch AppUITests" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO 
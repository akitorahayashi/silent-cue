name: SilentCue CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  copilot-review:
    name: Copilot Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
      
    steps:
      - uses: actions/checkout@v4
      
      - name: Add PR Review Comment (Simulated)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              ...context.repo,
              issue_number: context.payload.pull_request.number,
              body: "üëã Copilot„É¨„Éì„É•„Éº: „Ç≥„Éº„Éâ„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Åó„Åæ„Åô"
            });

#   format-and-lint:
#     name: Format and Lint
#     runs-on: macos-14
#     steps:
#     - uses: actions/checkout@v4

#     # --- Format and Lint Steps --- 
#     - name: Install dependencies (Mint)
#       run: |
#         brew install mint
#         mint bootstrap

#     - name: Show Tool Versions
#       run: |
#         mint run swiftlint version
#         mint run swiftformat --version
        
#     - name: Run SwiftFormat
#       run: |
#         mint run swiftformat .
        
#     - name: Run SwiftLint
#       run: |
#         mint run swiftlint --strict

#     - name: Check for changes after linting (should be none)
#       run: |
#         git diff --exit-code || { echo "„Ç≥„Éº„Éâ„Éï„Ç©„Éº„Éû„ÉÉ„Éà„ÅÆÂïèÈ°å„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åó„Åü„ÄÇ„É≠„Éº„Ç´„É´„Åß SwiftFormat „Å® SwiftLint „ÇíÂÆüË°å„Åó„ÄÅÂ§âÊõ¥„Çí„Ç≥„Éü„ÉÉ„Éà„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"; exit 1; }

  build:
    name: Build
    # needs: format-and-lint
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.2'
        
    - name: Check Xcode version
      run: |
        xcodebuild -version
        
    - name: Create Export Options Plist
      run: |
        # This is a placeholder Team ID. Replace with your actual Team ID if needed for real builds.
        cat > ExportOptions.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>development</string>
            <key>teamID</key>
            <string>DEVELOPMENT_TEAM_ID</string> 
            <key>compileBitcode</key>
            <false/>
            <key>signingStyle</key>
            <string>manual</string>
            <key>provisioningProfiles</key>
            <dict>
                <key>com.akitorahayashi.SilentCue.WatchApp</key>
                <string>Development Provisioning Profile Name</string> 
            </dict>
        </dict>
        </plist>
        EOF
        echo "Generated ExportOptions.plist:"
        cat ExportOptions.plist

    - name: Build App for Testing
      run: |
        # Get Simulator ID
        echo "--- Available watchOS Simulators ---"
        xcrun simctl list devices available | grep -A 20 "watchOS"
        echo "---------------------------------"

        SIMULATOR_ID=$(xcrun simctl list devices available | \
          grep 'Apple Watch Series 10 (42mm)' | \
          grep -oE '[0-9A-F\-]{36}' | \
          head -n 1)

        if [ -z "$SIMULATOR_ID" ]; then
          echo "Error: Apple Watch Series 10 (42mm) „Ç∑„Éü„É•„É¨„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì"
          exit 1
        fi
        echo "Using Simulator ID: $SIMULATOR_ID (Apple Watch Series 10 (42mm))"

        # Build
        xcodebuild build-for-testing \
          -project "SilentCue.xcodeproj" \
          -scheme "SilentCue Watch App" \
          -destination "platform=watchOS Simulator,id=$SIMULATOR_ID" \
          -configuration Debug \
          -derivedDataPath ./DerivedData \
          CODE_SIGNING_ALLOWED=NO
    
    - name: Create Archive for Build
      run: |
        mkdir -p ./archives
        tar czf ./archives/build-artifacts.tar.gz -C ./DerivedData .
    
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: ./archives/build-artifacts.tar.gz
        retention-days: 1

  unit-tests:
    name: Run Unit Tests
    needs: build
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.2'
        
    - name: Download Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
        path: ./archives
        
    - name: Extract Build Artifacts
      run: |
        mkdir -p ./DerivedData
        tar xzf ./archives/build-artifacts.tar.gz -C ./DerivedData
    
    - name: Run Unit Tests
      run: |
        # Get Simulator ID
        echo "--- Available watchOS Simulators ---"
        xcrun simctl list devices available | grep -A 20 "watchOS"
        echo "---------------------------------"

        SIMULATOR_ID=$(xcrun simctl list devices available | \
          grep 'Apple Watch Series 10 (42mm)' | \
          grep -oE '[0-9A-F\-]{36}' | \
          head -n 1)

        if [ -z "$SIMULATOR_ID" ]; then
          echo "Error: Apple Watch Series 10 (42mm) „Ç∑„Éü„É•„É¨„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì"
          exit 1
        fi
        echo "Using Simulator ID: $SIMULATOR_ID (Apple Watch Series 10 (42mm))"
        
        # Run Tests
        xcodebuild test-without-building \
          -project "SilentCue.xcodeproj" \
          -scheme "SilentCue Watch App" \
          -destination "platform=watchOS Simulator,id=$SIMULATOR_ID" \
          -configuration Debug \
          -derivedDataPath ./DerivedData \
          -only-testing:"SilentCue Watch AppTests" \
          CODE_SIGNING_ALLOWED=NO

  ui-tests:
    name: Run UI Tests
    needs: build
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.2'
      
    - name: Install dependencies
      run: |
        brew install mint
        mint bootstrap
        
    - name: Download Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
        path: ./archives
        
    - name: Extract Build Artifacts
      run: |
        mkdir -p ./DerivedData
        tar xzf ./archives/build-artifacts.tar.gz -C ./DerivedData
    
    - name: Run UI Tests
      run: |
        # Get Simulator ID
        echo "--- Available watchOS Simulators ---"
        xcrun simctl list devices available | grep -A 20 "watchOS"
        echo "---------------------------------"

        SIMULATOR_ID=$(xcrun simctl list devices available | \
          grep 'Apple Watch Series 10 (42mm)' | \
          grep -oE '[0-9A-F\-]{36}' | \
          head -n 1)

        if [ -z "$SIMULATOR_ID" ]; then
          echo "Error: Apple Watch Series 10 (42mm) „Ç∑„Éü„É•„É¨„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì"
          exit 1
        fi
        echo "Using Simulator ID: $SIMULATOR_ID (Apple Watch Series 10 (42mm))"

        # Run Tests
        xcodebuild test-without-building \
          -project "SilentCue.xcodeproj" \
          -scheme "SilentCue Watch App" \
          -destination "platform=watchOS Simulator,id=$SIMULATOR_ID" \
          -configuration Debug \
          -derivedDataPath ./DerivedData \
          -only-testing:"SilentCue Watch AppUITests" \
          CODE_SIGNING_ALLOWED=NO 